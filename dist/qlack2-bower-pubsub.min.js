!function(e){function t(e){u&&console.debug("QPubSub [",l,"]:",e)}function i(e){u&&console.debug("QPubSub [",l,"]:",e.data)}function n(){for(;void 0!==p&&(p.postMessage({clientID:l,msgType:m.CONTROL,msg:f.PING},"*"),p!==e.parent);)p=e.parent}function a(e,i){return g?void p.postMessage({clientID:l,msgType:m.PUB,topic:e,msg:i},"*"):void t("Tried to publish using a non-initialised PubSub instance.")}function s(e,i){return g?(p.postMessage({clientID:l,msgType:m.SUB,msg:e},"*"),void(b[e]=i)):void t("Tried to subscribe using a non-initialised PubSub instance.")}function c(e){return g?(p.postMessage({clientID:l,msgType:m.UNSUB,msg:e},"*"),void delete b[e]):void t("Tried to unsubscribe using a non-initialised PubSub instance.")}function o(a,s){l=a,r=s,t("Initialising, server: "+s),e.addEventListener("message",function(e){switch(e.data.msgType){case m.CONTROL:e.data.msg==f.PING?e.data.clientID!=l&&(t("Received PING from [ "+e.data.clientID+" ]"),e.source.postMessage({clientID:l,msgType:m.CONTROL,msg:f.PONG},"*")):e.data.msg==f.PONG&&(p=e.source,t("Received PONG from [ "+e.data.clientID+" ]"),t("Setting as parent/server instance [ "+e.data.clientID+" ]"));break;case m.SUB:t("Received SUB from [ "+e.data.clientID+" ]"),I.push({topic:e.data.msg,clientID:e.data.clientID,clientAgent:e.source});break;case m.UNSUB:t("Received UNSUB from [ "+e.data.clientID+" ]"),I=_.filter(I,function(t){return t.topic!==e.data.topic&&t.clientID!==e.data.clientID});break;case m.PUB:t("Received PUB from [ "+e.data.clientID+" ] to topic [ "+e.data.topic+" ]");var n=_.filter(I,{topic:e.data.topic});t("Found [ "+n.length+" ] subscribers."),_.forEach(n,function(t){t.clientAgent.postMessage({topic:e.data.topic,clientID:l,originalClientID:e.data.clientID,msgType:m.CALLBACK,msg:e.data.msg},"*")});break;case m.CALLBACK:t("Received CALLBACK from [ "+e.data.clientID+" ] from original client [ "+e.data.originalClientID+" ] to topic [ "+e.data.topic+" ]"),b[e.data.topic](e.data);break;default:i(e)}},!1),r||n(),g=!0}function d(e){u=e}var r,u=!0,l=void 0,g=!1,p=e,b=[],I=[],m={CONTROL:1,PUB:2,SUB:3,CALLBACK:4,UNSUB:5},f={PING:"ping",PONG:"pong"};e.QPubSub={init:o,publish:a,subscribe:s,logEnabled:u,unsubscribe:c,setLogActive:d}}(window);