!function(i){function e(i){d&&console.debug("QPubSub [",g,"]:",i)}function t(i){d&&console.debug("QPubSub [",g,"]:",i.data)}function n(){for(;void 0!==p&&(p.postMessage({clientID:g,msgType:I.CONTROL,msg:m.PING},p.origin),p!==i.parent);)p=i.parent}function a(i,t){if(!l)return void e("Tried to publish using a non-initialised PubSub instance.");p.postMessage({clientID:g,msgType:I.PUB,topic:i,msg:t},p.origin)}function o(i,t){if(!l)return void e("Tried to subscribe using a non-initialised PubSub instance.");p.postMessage({clientID:g,msgType:I.SUB,msg:i},p.origin),b[i]=t}function s(i){if(!l)return void e("Tried to unsubscribe using a non-initialised PubSub instance.");p.postMessage({clientID:g,msgType:I.UNSUB,msg:i},p.origin),delete b[i]}function c(a,o,s){g=a,u=o,e("Initialising (server = "+o+")"),s||console.log("WARNING! You are initialising QPubSub with no `allowedOrigins`; this is a potential security vulnerability for your application."),i.addEventListener("message",function(i){if(s&&-1==s.indexOf(i.origin))return void e("WARNING! Received a message from an unauthorised sender at: "+i.origin+". Message will be ignored.");switch(i.data.msgType){case I.CONTROL:i.data.msg==m.PING?i.data.clientID!=g&&(e("Received PING from [ "+i.data.clientID+" ]"),i.source.postMessage({clientID:g,msgType:I.CONTROL,msg:m.PONG},i.origin)):i.data.msg==m.PONG&&(p=i.source,e("Received PONG from [ "+i.data.clientID+" ]"),e("Setting as parent/server instance [ "+i.data.clientID+" ]"));break;case I.SUB:e("Received SUB from [ "+i.data.clientID+" ]"),f.push({topic:i.data.msg,clientID:i.data.clientID,clientAgent:i.source,clientSource:i.origin});break;case I.UNSUB:e("Received UNSUB from [ "+i.data.clientID+" ]"),f=_.filter(f,function(e){return e.topic!==i.data.topic&&e.clientID!==i.data.clientID});break;case I.PUB:e("Received PUB from [ "+i.data.clientID+" ] to topic [ "+i.data.topic+" ]");var n=_.filter(f,{topic:i.data.topic});e("Found [ "+n.length+" ] subscribers."),_.forEach(n,function(e){e.clientAgent.postMessage({topic:i.data.topic,clientID:g,originalClientID:i.data.clientID,msgType:I.CALLBACK,msg:i.data.msg},e.clientSource)});break;case I.CALLBACK:e("Received CALLBACK from [ "+i.data.clientID+" ] from original client [ "+i.data.originalClientID+" ] to topic [ "+i.data.topic+" ]"),b[i.data.topic](i.data);break;default:t(i)}},!1),u||n(),l=!0}function r(i){d=i}var u,d=!0,g=void 0,l=!1,p=i,b=[],f=[],I={CONTROL:1,PUB:2,SUB:3,CALLBACK:4,UNSUB:5},m={PING:"ping",PONG:"pong"};i.QPubSub={init:c,publish:a,subscribe:o,logEnabled:d,unsubscribe:s,setLogActive:r}}(window);