!function(i){function e(i){d&&console.debug("QPubSub [",l,"]:",i)}function t(i){d&&console.debug("QPubSub [",l,"]:",i.data)}function n(){for(;void 0!==p&&(p.postMessage({clientID:l,msgType:m.CONTROL,msg:D.PING},b),p!==i.parent);)p=i.parent}function a(i,t){if(!g)return void e("Tried to publish using a non-initialised PubSub instance.");p.postMessage({clientID:l,msgType:m.PUB,topic:i,msg:t},b)}function o(i,t){if(!g)return void e("Tried to subscribe using a non-initialised PubSub instance.");p.postMessage({clientID:l,msgType:m.SUB,msg:i},b),f[i]=t}function s(i){if(!g)return void e("Tried to unsubscribe using a non-initialised PubSub instance.");p.postMessage({clientID:l,msgType:m.UNSUB,msg:i},b),delete f[i]}function c(a,o,s){l=a,u=o,e("Initialising (server = "+o+")"),s||console.log("WARNING! You are initialising QPubSub with no `allowedOrigins`; this is a potential security vulnerability for your application."),i.addEventListener("message",function(i){if(s&&-1==s.indexOf(i.origin))return void e("WARNING! Received a message from an unauthorised sender at: "+i.origin+". Message will be ignored.");switch(i.data.msgType){case m.CONTROL:i.data.msg==D.PING?i.data.clientID!=l&&(e("Received PING from [ "+i.data.clientID+" ]"),i.source.postMessage({clientID:l,msgType:m.CONTROL,msg:D.PONG},i.origin)):i.data.msg==D.PONG&&(p=i.source,e("Received PONG from [ "+i.data.clientID+" ]"),e("Setting as parent/server instance [ "+i.data.clientID+" ]"));break;case m.SUB:e("Received SUB from [ "+i.data.clientID+" ]"),I.push({topic:i.data.msg,clientID:i.data.clientID,clientAgent:i.source,clientSource:i.origin});break;case m.UNSUB:e("Received UNSUB from [ "+i.data.clientID+" ]"),I=_.filter(I,function(e){return e.topic!==i.data.topic&&e.clientID!==i.data.clientID});break;case m.PUB:e("Received PUB from [ "+i.data.clientID+" ] to topic [ "+i.data.topic+" ]");var n=_.filter(I,{topic:i.data.topic});e("Found [ "+n.length+" ] subscribers."),_.forEach(n,function(e){e.clientAgent.postMessage({topic:i.data.topic,clientID:l,originalClientID:i.data.clientID,msgType:m.CALLBACK,msg:i.data.msg},e.clientSource)});break;case m.CALLBACK:e("Received CALLBACK from [ "+i.data.clientID+" ] from original client [ "+i.data.originalClientID+" ] to topic [ "+i.data.topic+" ]"),f[i.data.topic](i.data);break;default:t(i)}},!1),u||n(),g=!0}function r(i){d=i}var u,d=!0,l=void 0,g=!1,p=i,b=p.location.protocol+"//"+p.location.host,f=[],I=[],m={CONTROL:1,PUB:2,SUB:3,CALLBACK:4,UNSUB:5},D={PING:"ping",PONG:"pong"};i.QPubSub={init:c,publish:a,subscribe:o,logEnabled:d,unsubscribe:s,setLogActive:r}}(window);